name: Release Template

on:
  # ç›‘å¬ Release å‘å¸ƒäº‹ä»¶ï¼ˆç½‘é¡µç«¯æ“ä½œè§¦å‘ï¼‰
  release:
    types: [published]
  # ç›‘å¬ Tag æ¨é€äº‹ä»¶ï¼ˆå‘½ä»¤è¡Œæ“ä½œè§¦å‘ï¼‰
  push:
    tags:
      - 'v*.*.*'  # åªåŒ¹é… v1.0.0 è¿™æ ·çš„è¯­ä¹‰åŒ–ç‰ˆæœ¬æ ‡ç­¾
      - 'v*.*'    # ä¹ŸåŒ¹é… v1.0 è¿™æ ·çš„æ ‡ç­¾
    # æ˜ç¡®æ’é™¤æ™®é€šåˆ†æ”¯æ¨é€
    branches-ignore:
      - '**'

permissions:
  contents: write

jobs:
  package-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create macOS Package
        # æ’é™¤ Gitæ–‡ä»¶ã€Githubé…ç½®ã€Windowsè¯´æ˜ã€ä»¥åŠå¯èƒ½å­˜åœ¨çš„ zip æ–‡ä»¶
        run: |
          zip -r Xidian-LaTeX-Template-macOS.zip . -x "*.git*" -x ".github/*" -x ".gitignore" -x "WINDOWS_README.md" -x "*.zip"

      - name: Create Windows Package
        # æ’é™¤ Gitæ–‡ä»¶ã€Githubé…ç½®ã€MacTeXè®¾ç½®è„šæœ¬ã€ä»¥åŠä¹‹å‰ç”Ÿæˆçš„ macOS zip åŒ…
        run: |
          zip -r Xidian-LaTeX-Template-Windows.zip . -x "*.git*" -x ".github/*" -x ".gitignore" -x "MacTex_Installation_Settings/*" -x "switch-texlive.sh" -x "*.zip"

      - name: Generate Fixed Release Note
        # ç”Ÿæˆå›ºå®šçš„è¯´æ˜ä¿¡æ¯æ–‡ä»¶
        run: |
          cat <<EOF > release_note_footer.md
          
          ---
          ## ğŸ“¥ ä¸‹è½½ä¸å®‰è£… / Download & Install
          
          | æ“ä½œç³»ç»Ÿ / OS | æ¨èæ–‡ä»¶ / Recommended File | è¯´æ˜ / Note |
          | :--- | :--- | :--- |
          | **macOS** | \`Xidian-LaTeX-Template-macOS.zip\` | âœ… å†…å«å­—ä½“ & é…ç½®è„šæœ¬ (Includes fonts & scripts) |
          | **Windows** | \`Xidian-LaTeX-Template-Windows.zip\` | âœ… å†…å«å­—ä½“ (Includes fonts) |
          
          > âš ï¸ **æ³¨æ„ / Warning**: è¯·å‹¿ç›´æ¥ä¸‹è½½ \`Source code\`ï¼Œé™¤éä½ ç†Ÿæ‚‰ Git æ“ä½œã€‚è¯·ä¸‹è½½ä¸Šæ–¹è¡¨æ ¼ä¸­çš„ \`.zip\` æ–‡ä»¶ã€‚
          > Please download the \`.zip\` files listed above, NOT the \`Source code\`.
          
          ## ğŸ“– ä½¿ç”¨æ–‡æ¡£ / Documentation
          - [ä¸­æ–‡æ–‡æ¡£ (Chinese)](https://github.com/Ronchy2000/Xidian-LaTeX-Template-for-macOS/blob/master/README.md)
          - [English Guide](https://github.com/Ronchy2000/Xidian-LaTeX-Template-for-macOS/blob/master/README_EN.md)
          EOF

      - name: Create or Update Release with gh CLI
        # ä½¿ç”¨ gh CLI ç¡®ä¿ Release è¢«æ­£ç¡®åˆ›å»º
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # æ£€æŸ¥ Release æ˜¯å¦å­˜åœ¨
          if gh release view ${{ github.ref_name }} > /dev/null 2>&1; then
            echo "Release ${{ github.ref_name }} already exists, updating title..."
            # æ›´æ–°å·²å­˜åœ¨çš„ Release æ ‡é¢˜
            gh release edit ${{ github.ref_name }} --title "Xidian LaTeX Template ${{ github.ref_name }}"
          else
            echo "Creating new release ${{ github.ref_name }}..."
            gh release create ${{ github.ref_name }} \
              --title "Xidian LaTeX Template ${{ github.ref_name }}" \
              --notes "Release ${{ github.ref_name }}" \
              --generate-notes
          fi

      - name: Remove Existing Release Assets
        # åˆ é™¤å·²å­˜åœ¨çš„åŒåé™„ä»¶ï¼Œé¿å…é‡å¤ä¸Šä¼ å¤±è´¥
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${{ github.ref_name }}
          REPO=${{ github.repository }}
          for asset in Xidian-LaTeX-Template-macOS.zip Xidian-LaTeX-Template-Windows.zip; do
            ASSET_ID=$(gh release view "$TAG" --json assets -q ".assets[] | select(.name==\"$asset\").id")
            if [[ -n "$ASSET_ID" ]]; then
              echo "Deleting existing asset $asset (id: $ASSET_ID)"
              gh api \
                --method DELETE \
                -H "Accept: application/vnd.github+json" \
                "/repos/$REPO/releases/assets/$ASSET_ID"
            else
              echo "No existing asset named $asset"
            fi
          done

      - name: Upload Release Assets
        # ä½¿ç”¨ gh å‘½ä»¤è¡Œå·¥å…·ä¸Šä¼ æ–‡ä»¶ï¼Œæ”¯æŒè¦†ç›–ï¼ˆ--clobberï¼‰ï¼Œè§£å†³ 422 é”™è¯¯
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.ref_name }} \
            Xidian-LaTeX-Template-macOS.zip \
            Xidian-LaTeX-Template-Windows.zip \
            --clobber

      - name: Append Footer to Release Notes
        # æ™ºèƒ½è¿½åŠ å›ºå®šè¯´æ˜ï¼ˆé˜²æ­¢é‡å¤è¿½åŠ ï¼‰
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # è·å–å½“å‰ Release è¯´æ˜
          CURRENT_BODY=$(gh release view ${{ github.ref_name }} --json body -q .body)
          FOOTER_FILE="release_note_footer.md"
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»åŒ…å«å›ºå®šå†…å®¹çš„æ ‡è®°
          if [[ "$CURRENT_BODY" == *"## ğŸ“¥ ä¸‹è½½ä¸å®‰è£…"* ]]; then
            echo "Release notes already contain the footer. Skipping update."
          else
            echo "Appending footer to release notes..."
            # ç»„åˆæ–°å†…å®¹ï¼šä¿ç•™åŸæœ‰å†…å®¹ + æ¢è¡Œ + å›ºå®šFooter
            echo "$CURRENT_BODY" > full_notes.md
            echo "" >> full_notes.md
            cat $FOOTER_FILE >> full_notes.md
            
            # æ›´æ–° Release è¯´æ˜
            gh release edit ${{ github.ref_name }} --notes-file full_notes.md
          fi
